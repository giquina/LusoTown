# LusoTown Portuguese-speaking Community Streaming Configuration
# Optimized for Portuguese speakers in London & UK

# Global server configuration
listen              1935;
max_connections     10000;
srs_log_level       info;
srs_log_file        /usr/local/srs/logs/srs.log;
daemon              on;
pid                 /usr/local/srs/logs/srs.pid;

# HTTP API for stream management
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
    raw_api         on;
    auth {
        enabled     on;
        username    lusotown;
        password    $LUSOTOWN_STREAMING_SECRET;
    }
}

# HTTP streaming server
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
    crossdomain     on;
}

# RTC (WebRTC) configuration for low latency
rtc_server {
    enabled on;
    listen 8000;
    # STUN servers for Portuguese region optimization
    candidates {
        # London/UK STUN servers
        stun stun:stun.l.google.com:19302;
        stun stun1.l.google.com:19302;
        stun stun2.l.google.com:19302;
    }
}

# Portuguese-speaking Community Streaming vhost
vhost __defaultVhost__ {
    # Enable all protocols
    enabled         on;
    min_latency     on;
    tcp_nodelay     on;
    
    # RTMP configuration
    rtmp {
        enabled     on;
        time_jitter full;
    }
    
    # HLS configuration for mobile optimization
    hls {
        enabled         on;
        hls_fragment    2;
        hls_window      12;
        # Write HLS to the HTTP server dir so URLs resolve under /<app>/<stream>.m3u8 (e.g., /live/<id>.m3u8)
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
        hls_acodec      aac;
        hls_vcodec      h264;
        hls_dispose     30;
        hls_on_error    ignore;
        hls_storage     disk;
        
        # Portuguese mobile optimization
        hls_keys        on;
        hls_fragments_per_key 5;
        hls_key_file    [app]/[stream]-[seq].key;
        # Keep keys alongside segments for consistent pathing
        hls_key_file_path ./objs/nginx/html;
        hls_key_url     [server]/[app]/[stream]-[seq].key;
    }
    
    # WebRTC for ultra-low latency
    rtc {
        enabled     on;
        rtmp_to_rtc on;
        rtc_to_rtmp on;
    }
    
    # DVR for Portuguese content recording
    dvr {
        enabled      off;
        dvr_path     /tmp/srs-dvr;
        dvr_plan     session;
        dvr_duration 30;
        dvr_wait_keyframe on;
    }
    
    # Transcode for Portuguese market device compatibility
    transcode {
        enabled     off;
        ffmpeg      /usr/local/bin/ffmpeg;
        
        # Mobile-first transcoding
        engine mobile {
            enabled         on;
            vfilter {
                v               quiet;
                vf              scale=720:404;
            }
            vcodec          libx264;
            vbitrate        800;
            vfps            25;
            vwidth          720;
            vheight         404;
            vthreads        2;
            vprofile        baseline;
            vpreset         ultrafast;
            
            acodec          aac;
            abitrate        64;
            asample_rate    44100;
            achannels       2;
            
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_mobile;
        }
        
        # Desktop quality for Portuguese-speaking community
        engine desktop {
            enabled         on;
            vcodec          libx264;
            vbitrate        2000;
            vfps            30;
            vwidth          1280;
            vheight         720;
            vthreads        4;
            vprofile        high;
            vpreset         fast;
            
            acodec          aac;
            abitrate        128;
            asample_rate    44100;
            achannels       2;
            
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_hd;
        }
    }
    
    # Security and access control
    security {
        seo_control on;
        # Portuguese-speaking community authentication
        publish {
            enabled on;
            auth_url http://localhost:3000/api/streaming/auth/publish;
        }
        play {
            enabled on;
            auth_url http://localhost:3000/api/streaming/auth/play;
        }
    }
    
    # Statistics and analytics
    stats {
        network         0;
        disk            srs-disk;
    }
    
    # Portuguese content hooks
    http_hooks {
        enabled         on;
        on_connect      http://localhost:3000/api/streaming/hooks/connect;
        on_close        http://localhost:3000/api/streaming/hooks/close;
        on_publish      http://localhost:3000/api/streaming/hooks/publish;
        on_unpublish    http://localhost:3000/api/streaming/hooks/unpublish;
        on_play         http://localhost:3000/api/streaming/hooks/play;
        on_stop         http://localhost:3000/api/streaming/hooks/stop;
        on_dvr          http://localhost:3000/api/streaming/hooks/dvr;
    }
}

# Cluster configuration for scaling
cluster {
    enabled         off;
    mode            local;
    origin_cluster  off;
}

# Heartbeat for health monitoring
heartbeat {
    enabled         on;
    interval        9.9;
    url             http://localhost:3000/api/streaming/heartbeat;
    device_id       lusotown-streaming-001;
}