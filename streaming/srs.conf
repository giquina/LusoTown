# LusoTown Portuguese-speaking Community Streaming Configuration
# Optimized for Streamlabs Mobile and Portuguese Content

listen              1935;
max_connections     1000;
srs_log_tank        file;
srs_log_level       trace;
srs_log_file        ./logs/srs.log;
daemon              off;
utc_time            off;

# HTTP API for Portuguese-speaking community management
http_api {
    enabled         on;
    listen          1985;
    
    # CORS for Portuguese-speaking community web integration
    crossdomain     on;
    
    # Raw API for advanced Portuguese-speaking community features
    raw_api {
        enabled             on;
        allow_reload        on;
        allow_query         on;
        allow_update        on;
    }
}

# HTTP Server for HLS delivery to Portuguese-speaking community
http_server {
    enabled         on;
    listen          8080;
    dir             ./www;
    
    # CORS for Portuguese-speaking community access
    crossdomain     on;
}

# Statistics for Portuguese-speaking community analytics
stats {
    network         0;
    disk            sda sdb xvda xvdb;
}

# Main vhost for Portuguese-speaking community streaming
vhost __defaultVhost__ {
    # Streamlabs-optimized RTMP settings
    tcp_nodelay     on;
    min_latency     on;
    
    # Portuguese-speaking community authentication hooks
    http_hooks {
        enabled         on;
        on_connect      http://streaming-api:3002/api/streaming/hooks/connect;
        on_close        http://streaming-api:3002/api/streaming/hooks/close;
        on_publish      http://streaming-api:3002/api/streaming/hooks/publish;
        on_unpublish    http://streaming-api:3002/api/streaming/hooks/unpublish;
        on_play         http://streaming-api:3002/api/streaming/hooks/play;
        on_stop         http://streaming-api:3002/api/streaming/hooks/stop;
        on_dvr          http://streaming-api:3002/api/streaming/hooks/dvr;
        on_hls          http://streaming-api:3002/api/streaming/hooks/hls;
    }
    
    # Security for Portuguese-speaking community
    security {
        enabled         on;
        
        # Portuguese-speaking community stream authentication
        publish {
            enabled     on;
            
            # Allow Portuguese-speaking community creators
            allow       publish portuguese_*;
            allow       publish streamlabs_*;
            allow       publish lusotown_*;
            allow       publish cultural_*;
            allow       publish business_*;
        }
        
        play {
            enabled     on;
            
            # Allow Portuguese-speaking community viewers
            allow       play portuguese_*;
            allow       play streamlabs_*;
            allow       play lusotown_*;
            allow       play cultural_*;
            allow       play business_*;
        }
    }
    
    # HLS for Portuguese mobile viewers
    hls {
        enabled         on;
        hls_fragment    2;
        hls_window      12;
        hls_path        ./www;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
        
        # Mobile optimization for Portuguese-speaking community
        hls_ts_floor    off;
        hls_cleanup     on;
        hls_dispose     30;
        hls_nb_notify   10;
        hls_wait_keyframe   on;
        
        # Portuguese-speaking community HLS hooks
        hls_on_error    http://streaming-api:3002/api/streaming/hooks/hls_error;
    }
    
    # DVR for Portuguese cultural content preservation
    dvr {
        enabled         off;  # Disabled by default to save storage
        dvr_path        ./recordings;
        dvr_plan        session;
        dvr_duration    120;
        dvr_wait_keyframe   on;
    }
    
    # Forward to Portuguese-speaking community CDN (if configured)
    forward {
        enabled         off;
        destination     127.0.0.1:19350;
    }
    
    # Transcoding for Portuguese mobile optimization
    transcode {
        enabled         off;  # Disabled by default for performance
        ffmpeg          ./objs/ffmpeg/bin/ffmpeg;
        
        # Portuguese-speaking community mobile profile
        engine mobile {
            enabled         off;
            vfilter {
                v               quiet;
                vf              scale=720:480;
            }
            vcodec          libx264;
            vbitrate        800;
            vfps            25;
            vwidth          720;
            vheight         480;
            vthreads        2;
            vprofile        main;
            vpreset         fast;
            vparams {
                g               50;
                keyint_min      25;
                sc_threshold    0;
            }
            acodec          libfdk_aac;
            abitrate        64;
            asample_rate    44100;
            achannels       2;
            aparams {
                profile:a       aac_low;
                bsf:a           aac_adtstoasc;
            }
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_mobile;
        }
    }
    
    # Bandwidth adaptation for Portuguese-speaking community
    band_check {
        enabled         off;
        key             "35c9b402c12a7246868752e2878f7e0e";
        interval        30;
        limit_kbps      4000;
    }
    
    # Cluster for Portuguese-speaking community scaling
    cluster {
        mode            local;
        origin_cluster  off;
        token_traverse  off;
        vhost           __defaultVhost__;
    }
    
    # Real-time messaging for Portuguese chat
    rtc {
        enabled         off;  # Enable when WebRTC is needed
        rtc_server      127.0.0.1:8000;
    }
}

# Portuguese cultural content vhost
vhost cultural.lusotown.com {
    # Inherit from default
    include         __defaultVhost__;
    
    # Specific settings for cultural content
    hls {
        enabled         on;
        hls_fragment    3;
        hls_window      15;
    }
    
    # Enable DVR for cultural preservation
    dvr {
        enabled         on;
        dvr_path        ./recordings/cultural;
        dvr_plan        session;
        dvr_duration    180;
    }
}

# Portuguese business content vhost
vhost business.lusotown.com {
    # Inherit from default
    include         __defaultVhost__;
    
    # Specific settings for business workshops
    hls {
        enabled         on;
        hls_fragment    2;
        hls_window      10;
    }
    
    # Enable recording for business content
    dvr {
        enabled         on;
        dvr_path        ./recordings/business;
        dvr_plan        session;
        dvr_duration    240;
    }
}