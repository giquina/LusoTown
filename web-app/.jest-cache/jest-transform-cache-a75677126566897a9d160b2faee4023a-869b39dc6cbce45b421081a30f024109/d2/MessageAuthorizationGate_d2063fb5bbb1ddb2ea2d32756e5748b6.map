{"version":3,"sources":["/workspaces/LusoTown/web-app/src/components/MessageAuthorizationGate.tsx"],"sourcesContent":["'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useLanguage } from '@/context/LanguageContext'\nimport { messagingService, MessagePermissionCheck } from '@/services/messagingService'\nimport { motion } from 'framer-motion'\nimport { \n  MessageCircle, \n  Heart, \n  Calendar, \n  Users, \n  Lock, \n  AlertCircle,\n  CheckCircle,\n  Clock\n} from 'lucide-react'\n\ninterface MessageAuthorizationGateProps {\n  targetUserId: string\n  targetUserName: string\n  targetUserImage?: string\n  children: React.ReactNode\n  onPermissionGranted?: () => void\n  onPermissionDenied?: () => void\n}\n\nexport default function MessageAuthorizationGate({\n  targetUserId,\n  targetUserName,\n  targetUserImage,\n  children,\n  onPermissionGranted,\n  onPermissionDenied\n}: MessageAuthorizationGateProps) {\n  const { language } = useLanguage()\n  const [permission, setPermission] = useState<MessagePermissionCheck | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n\n  const translations = {\n    en: {\n      checking: 'Checking messaging permissions...',\n      authorized: 'You can message this user',\n      unauthorized: 'Unable to send message',\n      mutualMatch: 'You are mutually matched',\n      sharedEvents: 'You attended events together',\n      noPermission: 'You can only message users you are matched with or have attended events together.',\n      howToMessage: 'How to message this user:',\n      steps: {\n        match: 'Like their profile and wait for them to like you back',\n        event: 'Attend the same community events to unlock messaging'\n      },\n      sharedEventsCount: (count: number) => `${count} shared event${count === 1 ? '' : 's'}`,\n      learnMore: 'Learn about our safety features',\n      tryAgain: 'Check again'\n    },\n    pt: {\n      checking: 'Verificando permissões de mensagem...',\n      authorized: 'Pode enviar mensagem a este utilizador',\n      unauthorized: 'Não é possível enviar mensagem',\n      mutualMatch: 'Vocês fazem match mútuo',\n      sharedEvents: 'Participaram em eventos juntos',\n      noPermission: 'Só pode enviar mensagens a utilizadores com quem faz match ou participou em eventos juntos.',\n      howToMessage: 'Como enviar mensagem a este utilizador:',\n      steps: {\n        match: 'Goste do perfil deles e espere que gostem do seu',\n        event: 'Participe nos mesmos eventos da comunidade para desbloquear mensagens'\n      },\n      sharedEventsCount: (count: number) => `${count} evento${count === 1 ? '' : 's'} partilhado${count === 1 ? '' : 's'}`,\n      learnMore: 'Saiba mais sobre as nossas funcionalidades de segurança',\n      tryAgain: 'Tentar novamente'\n    }\n  }\n\n  const t = translations[language]\n\n  useEffect(() => {\n    checkPermissions()\n  }, [targetUserId])\n\n  const checkPermissions = async () => {\n    if (!targetUserId) return\n\n    try {\n      setLoading(true)\n      setError(null)\n      \n      const permissionResult = await messagingService.checkMessagePermission(targetUserId)\n      setPermission(permissionResult)\n      \n      if (permissionResult.can_message && onPermissionGranted) {\n        onPermissionGranted()\n      } else if (!permissionResult.can_message && onPermissionDenied) {\n        onPermissionDenied()\n      }\n    } catch (err) {\n      console.error('Error checking message permissions:', err)\n      setError(err instanceof Error ? err.message : 'Unknown error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <div className=\"flex items-center space-x-3 text-gray-600\">\n          <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600\"></div>\n          <span>{t.checking}</span>\n        </div>\n      </div>\n    )\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-6 bg-red-50 border border-red-200 rounded-lg\">\n        <div className=\"flex items-center space-x-3 text-red-700 mb-4\">\n          <AlertCircle className=\"h-5 w-5\" />\n          <span className=\"font-medium\">Error</span>\n        </div>\n        <p className=\"text-red-600 mb-4\">{error}</p>\n        <button\n          onClick={checkPermissions}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors\"\n        >\n          {t.tryAgain}\n        </button>\n      </div>\n    )\n  }\n\n  // If user has permission, render children (messaging interface)\n  if (permission?.can_message) {\n    return (\n      <div className=\"space-y-4\">\n        <motion.div\n          initial={{ opacity: 0, y: -10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"p-4 bg-green-50 border border-green-200 rounded-lg\"\n        >\n          <div className=\"flex items-center space-x-3 text-green-700\">\n            <CheckCircle className=\"h-5 w-5\" />\n            <span className=\"font-medium\">{t.authorized}</span>\n          </div>\n          \n          <div className=\"mt-3 flex flex-wrap gap-2\">\n            {permission.has_mutual_match && (\n              <div className=\"flex items-center space-x-2 px-3 py-1 bg-green-100 rounded-full text-sm text-green-700\">\n                <Heart className=\"h-4 w-4\" />\n                <span>{t.mutualMatch}</span>\n              </div>\n            )}\n            \n            {permission.has_event_permission && (\n              <div className=\"flex items-center space-x-2 px-3 py-1 bg-blue-100 rounded-full text-sm text-blue-700\">\n                <Calendar className=\"h-4 w-4\" />\n                <span>{t.sharedEventsCount(permission.shared_events_count)}</span>\n              </div>\n            )}\n          </div>\n        </motion.div>\n        \n        {children}\n      </div>\n    )\n  }\n\n  // If no permission, show explanation and guidance\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      className=\"p-6 bg-gray-50 border border-gray-200 rounded-lg\"\n    >\n      <div className=\"flex items-center space-x-3 text-gray-700 mb-4\">\n        <Lock className=\"h-5 w-5\" />\n        <span className=\"font-medium\">{t.unauthorized}</span>\n      </div>\n      \n      <div className=\"flex items-center space-x-4 mb-6\">\n        {targetUserImage && (\n          <img\n            src={targetUserImage}\n            alt={targetUserName}\n            className=\"w-12 h-12 rounded-full object-cover\"\n          />\n        )}\n        <div>\n          <h3 className=\"font-medium text-gray-900\">{targetUserName}</h3>\n          <p className=\"text-sm text-gray-600\">{t.noPermission}</p>\n        </div>\n      </div>\n      \n      <div className=\"space-y-4\">\n        <h4 className=\"font-medium text-gray-900\">{t.howToMessage}</h4>\n        \n        <div className=\"space-y-3\">\n          <div className=\"flex items-start space-x-3 p-3 bg-white rounded-lg border\">\n            <Heart className=\"h-5 w-5 text-primary-600 mt-0.5\" />\n            <div>\n              <h5 className=\"font-medium text-gray-900\">Mutual Match</h5>\n              <p className=\"text-sm text-gray-600\">{t.steps.match}</p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-start space-x-3 p-3 bg-white rounded-lg border\">\n            <Calendar className=\"h-5 w-5 text-secondary-600 mt-0.5\" />\n            <div>\n              <h5 className=\"font-medium text-gray-900\">Shared Events</h5>\n              <p className=\"text-sm text-gray-600\">{t.steps.event}</p>\n            </div>\n          </div>\n        </div>\n        \n        <div className=\"pt-4 border-t\">\n          <button className=\"text-sm text-primary-600 hover:text-primary-700 flex items-center space-x-2\">\n            <Users className=\"h-4 w-4\" />\n            <span>{t.learnMore}</span>\n          </button>\n        </div>\n      </div>\n    </motion.div>\n  )\n}"],"names":["MessageAuthorizationGate","targetUserId","targetUserName","targetUserImage","children","onPermissionGranted","onPermissionDenied","language","useLanguage","permission","setPermission","useState","loading","setLoading","error","setError","translations","en","checking","authorized","unauthorized","mutualMatch","sharedEvents","noPermission","howToMessage","steps","match","event","sharedEventsCount","count","learnMore","tryAgain","pt","t","useEffect","checkPermissions","permissionResult","messagingService","checkMessagePermission","can_message","err","console","Error","message","div","className","span","AlertCircle","p","button","onClick","motion","initial","opacity","y","animate","CheckCircle","has_mutual_match","Heart","has_event_permission","Calendar","shared_events_count","Lock","img","src","alt","h3","h4","h5","Users"],"mappings":"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"}